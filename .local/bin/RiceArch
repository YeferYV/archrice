#!/bin/bash

#
## Before chroot
#
# cfdisk
# mkfs.vat /dev/sdX
# mkfs.btrfs /dev/sdX
# mount /dev/sdX /mnt
# btrfs su cr /mnt/@root
# btrfs su cr /mnt/@home
# btrfs su cr /mnt/@var
# btrfs su cr /mnt/@swap
# btrfs su cr /mnt/@.snapshots
# mount -o noatime,compress=lzo,subvol=@root /dev/sdX /mnt
# mkdir -p /mnt/{boot/efi,home,var,swap,.snapshots}
# mount -o noatime,compress=lzo,subvol=@home /dev/sdX /mnt/home
# mount -o noatime,compress=lzo,subvol=@.snapshots /dev/sdX /mnt/.snapshots
# mount -o nodatacow,subvol=@swap /dev/sdX /mnt/swap
# mount -o nodatacow,subvol=@var /dev/sdX /mnt/var
# mount /dev/sdX /mnt/boot/efi
#
# pacstrap /mnt base base-devel broadcom-wl btrfs-progs efibootmgr grub linux linux-firmware neovim networkmanager snapper git cronie
#
# genfstab U /mnt >> /mnt/etc/fstab

#
##  After chroot
#
# arch-chroot /mnt
# truncate -s 0 /swap/swapfile
# chattr +C /swap/swapfile
# btrfs property set /swap/swapfile compression none
# dd if=/dev/zero of=/swap/swapfile bs=1G count=8 status=progress
# chmod 600 /swap/swapfile
# mkswap /swap/swapfile
# swapon /swap/swapfile
# echo "/swap/swapfile none defaults 0 0" >> /etc/fstab
#
# sed -i "s/MODULE=()/MODULE=(btrfs)/" /etc/mkinitcpio.conf
# mkinitcpio -p linux
#
# umount /.snapshots
# rm -rf /.snapshots
# snapper -c rootsnap create-config /
# reboot

#
## After reboot
#

timedatectl set-ntp true
hwclock --systohc
ln -sf /usr/share/zoneinfo/US/Eastern /etc/localtime

sed -i '177s/.//' /etc/locale.gen
locale-gen
echo "LANG=en_US.UTF-8" >> /etc/locale.conf
# echo "KEYMAP=en_US.UTF-8" >> /etc/vconsole.conf

echo "4rch" >> /etc/hostname
echo "127.0.0.1 localhost" >> /etc/hosts
echo "::1       localhost" >> /etc/hosts
echo "127.0.1.1 4rch.localdomain 4rch" >> /etc/hosts
echo root:toor | chpasswd

grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg

systemctl enable NetworkManager
systemctl enable cronie
# systemctl enable libvirtd
# systemctl enable firewalld
# systemctl enable avahi-daemon
useradd -m drknss
usermod -aG libvirt video drknss
echo drknss:toor | chpasswd
echo "drknss ALL=(ALL) ALL" >> /etc/sudoers.d/drknss

#
## Backup
#
# rm -rf /.snapshots
# snapper -c rootsnap create-config /
# reboot
btrfs su snapshot / /.snapshots/backup-$(date +%y-%m-%d)
snapper -c rootsnap create -d "base-install"

rm -rf /home
snapper -c homesnap create-config /home
btrfs su snapshot /home /home/.snapshots/backup-$(date +%y-%m-%d)
snapper -c homesnap create -d "base-install"

rm -rf /var
snapper -c varsnap create-config /var
btrfs su snapshot /var /var/.snapshots/backup-$(date +%y-%m-%d)
snapper -c varsnap create -d "base-install"

mkdir /home/drknss/.config
btrfs su cr /home/drknss/.config/google-chrome
btrfs su cr /root/.cache
btrfs su cr /var/log
btrfs su cr /var/tmp
btrfs su cr /var/cache/pacman/pkg

#
## Post-Install
#

# pacman-key --init
# pacman-key --populate
mkdir -p /home/dtfls/yydtfls
git clone https://gitlab.com/yucrayeff36/dotfiles /home/dtfls/yydtfls/dotfiles
cd /home/dtfls/yydtfls/dotfiles
./.local/bin/ResetArch
mkdir ~/.local/share/mpd
systemctl --user start mpd
systemctl --user start pulseaudio-x11
systemctl --user start touchcursor
mpc --port=6601 update
stow --restow --verbose --target=/home/drknss/.config .config
stow --restow --verbose --target=/home/drknss/.local .local
ls -s ~/.config/shell/profile ~/.profile
ls -s ~/.config/x11/.xinitrc ~/.xinitrc
sudo cp ~/.config/x11/10-synaptics.conf /etc/X11/xorg.conf.d/
crontab ~/.local/bin/cron/lowbatnotificationcron

snapper -c rootsnap create -d "after-resetarch"
snapper -c homesnap create -d "after-resetarch"
snapper -c varsnap create -d "after-resetarch"
# snapper -c rootsnap create -d "after-larbs"
# snapper -c homesnap create -d "after-larbs"
# snapper -c varsnap create -d "after-larbs"
snapper -c rootsnap create -c timeline -d "hourly-snapshots"
snapper -c homesnap create -c timeline -d "hourly-snapshots"
snapper -c varsnap create -c timeline -d "hourly-snapshots"

printf "\e[1;32mDone!\e[0m"

