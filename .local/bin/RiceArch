#!/bin/bash

#
## Before-Chroot (partitioning)
#
# cfdisk
# mkfs.vat /dev/sdX
# mkfs.btrfs /dev/sdX
# mount /dev/sdX /mnt
# btrfs su cr /mnt/@
# btrfs su cr /mnt/@home
# btrfs su cr /mnt/@swap
# btrfs su cr /mnt/@.snapshots
# mount -o noatime,compress=lzo,subvol=@ /dev/sdX /mnt
# mkdir -p /mnt/{boot/efi,home,swap,.snapshots}
# mount -o noatime,compress=lzo,subvol=@home /dev/sdX /mnt/home
# mount -o noatime,compress=lzo,subvol=@.snapshots /dev/sdX /mnt/.snapshots
# mount -o nodatacow,subvol=@swap /dev/sdX /mnt/swap
# mount /dev/sdX /mnt/boot/efi
# pacstrap /mnt base base-devel broadcom-wl btrfs-progs efibootmgr grub linux linux-firmware neovim networkmanager snapper git cronie
# genfstab U /mnt >> /mnt/etc/fstab
# sed -i "s/MODULE=()/MODULE=(btrfs)/" /etc/mkinitcpio.conf
# mkinitcpio -p linux

#
##  After-Chroot (swap)
#
# arch-chroot /mnt
# truncate -s 0 /swap/swapfile
# chattr +C /swap/swapfile
# btrfs property set /swap/swapfile compression none
# dd if=/dev/zero of=/swap/swapfile bs=1G count=8 status=progress
# chmod 600 /swap/swapfile
# mkswap /swap/swapfile
# swapon /swap/swapfile
# echo "/swap/swapfile none defaults 0 0" >> /etc/fstab

#
## After-Reboot (configs)
#

set -eu # exit on error
[ $(id -u) != 0 ] && echo "\e[1;33mRun it as root user at root's folder\e[0m\n" >&2 && exit 1
printf "\e[1;33mAfter-Reboot\e[0m\n"
timedatectl set-ntp true
hwclock --systohc
ln -sf /usr/share/zoneinfo/US/Eastern /etc/localtime

sed -i '177s/#//' /etc/locale.gen
locale-gen
echo "LANG=en_US.UTF-8" > /etc/locale.conf
# echo "KEYMAP=en_US.UTF-8" >> /etc/vconsole.conf

echo "4rch" > /etc/hostname
echo "127.0.0.1 localhost" >> /etc/hosts
echo "::1       localhost" >> /etc/hosts
echo "127.0.1.1 4rch.localdomain 4rch" >> /etc/hosts
echo root:toor | chpasswd

grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg

systemctl enable NetworkManager
systemctl enable cronie
# systemctl enable libvirtd
# systemctl enable firewalld
# systemctl enable avahi-daemon
useradd -m drknss
usermod -aG video wheel drknss
echo drknss:toor | chpasswd
echo "drknss ALL=(ALL) ALL" > /etc/sudoers.d/drknss

#
## Backups (btrfs)
#

# mount -o subvolid=5 /mnt
# mv /mnt/<@root> /mnt/@
# btrfs su get-default /mnt
# btrfs su set-default /mnt/@
printf "\e[1;33mBackups\e[0m\n"
mv /home /home.bak
btrfs su cr /home
mv /home.bak/* /home
rm -rf /.snapshots /home.bak
snapper -c root create-config /
snapper -c home create-config /home
snapper -c root create -d "base-install"
snapper -c home create -d "base-install"

mkdir /home/drknss/.config
btrfs su snapshot / /.snapshots/backup-$(date +%y-%m-%d)-snapper-base-install
btrfs su snapshot /home /home/.snapshots/backup-$(date +%y-%m-%d)-snapper-base-install
btrfs su cr /home/drknss/.config/google-chrome

#
## Post-Install (dotfiles)
#

printf "\e[1;33mPost-Install\e[0m\n"
mkdir -p /home/drknss/.local
mkdir -p /home/dtfls/yydtfls
git clone https://gitlab.com/yucrayeff36/dotfiles /home/dtfls/yydtfls/dotfiles
cd /home/dtfls/yydtfls/dotfiles
stow --restow --verbose --target=/home/drknss/.config .config
stow --restow --verbose --target=/home/drknss/.local .local
mkdir -p /home/drknss/.local/share/mpd
# sudo -u drknss systemctl --user enable mpd
# sudo -u drknss systemctl --user enable pulseaudio-x11
# sudo -u drknss systemctl --user enable touchcursor
# sudo -u drknss mpc --port=6601 update
ln -s /home/drknss/.config/shell/profile /home/drknss/.zprofile
ln -s /home/drknss/.config/x11/.xinitrc /home/drknss/.xinitrc
cp /home/drknss/.config/x11/10-synaptics.conf /etc/X11/xorg.conf.d/
cp /home/drknss/.config/wallhaven-4lokdp.jpg /home/drknss/.local/share/bg
crontab /home/drknss/.local/bin/cron/lowbatnotificationcron
chsh --shell /usr/bin/zsh drknss
mkdir -p /home/drknss/.config/nvim/autoload/
curl "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim" > /home/drknss/.config/nvim/autoload/plug.vim
chown -R drknss:drknss /home/drknss
chown -R drknss:drknss /home/dtfls
sudo -u "drknss" -D~ bash -c "nvim --headless +PlugInstall +qall"

# nerd fonts
mkdir -p ~/.local/share/fonts
git clone --filter=blob:none --sparse https://github.com/ryanoasis/nerd-fonts
cd nerd-fonts
git sparse-checkout add patched-fonts/3070
cp -r patched-fonts/3070 ~/.local/share/fonts/

snapper -c root create -d "after-RiceArch"
snapper -c home create -d "after-RiceArch"
# snapper -c root create -d "after-larbs"
# snapper -c home create -d "after-larbs"
# snapper -c root create -c timeline -d "hourly-snapshots"
# snapper -c home create -c timeline -d "hourly-snapshots"

printf "\e[1;32mDone!\e[0m\n"
